// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TREASURER
  ASSEMBLY_LEADER
  VIEWER
}

model RolePermission {
  id         String   @id @default(cuid())
  role       Role     @unique
  canViewAll Boolean  @default(false)
  canManageIncome Boolean @default(false)
  canManageExpenses Boolean @default(false)
  canManageReceivables Boolean @default(false)
  canManageVentures Boolean @default(false)
  canManageProjects Boolean @default(false)
  canManageAssets Boolean @default(false)
  canManageUsers Boolean @default(false)
  canManageAssemblies Boolean @default(false)
  canViewReports Boolean @default(false)
  canExport Boolean @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum Currency {
  USD
  ZWL
}

enum AssemblyStatus {
  ACTIVE
  INACTIVE
}

enum PaymentSource {
  OWED_PERSON
  CASH_AT_HAND
  PASTOR
}

enum ExpenseStatus {
  OWED
  PARTIAL
  PAID
}

enum AssetCategory {
  EQUIPMENT
  VEHICLE
  FURNITURE
  ELECTRONICS
  PROPERTY
  OTHER
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum PaymentMethod {
  CASH
  ECOCASH
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
}

enum VentureStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Venture {
  id          String        @id @default(cuid())
  name        String
  description String        @default("")
  status      VentureStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  products    VentureProduct[]
  expenses    VentureExpense[]
  allocations VentureAllocation[]
  payments    VenturePayment[]
}

model VentureProduct {
  id          String              @id @default(cuid())
  ventureId   String
  venture     Venture             @relation(fields: [ventureId], references: [id], onDelete: Cascade)
  name        String
  currency    Currency
  unitPrice   Float               @default(0)
  stock       Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  allocations VentureAllocation[]
}

model VentureExpense {
  id          String   @id @default(cuid())
  ventureId   String
  venture     Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)
  date        DateTime
  currency    Currency
  amount      Float
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model VentureAllocation {
  id          String          @id @default(cuid())
  ventureId   String
  venture     Venture         @relation(fields: [ventureId], references: [id], onDelete: Cascade)
  productId   String?
  product     VentureProduct? @relation(fields: [productId], references: [id])
  assemblyId  String
  assembly    Assembly        @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  date        DateTime
  currency    Currency
  quantity    Int             @default(0)
  unitPrice   Float           @default(0)
  totalAmount Float           @default(0)
  description String          @default("")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model VenturePayment {
  id            String        @id @default(cuid())
  ventureId     String
  venture       Venture       @relation(fields: [ventureId], references: [id], onDelete: Cascade)
  assemblyId    String
  assembly      Assembly      @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  date          DateTime
  currency      Currency
  amount        Float
  paymentMethod PaymentMethod
  description   String        @default("")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String        @default("")
  budget      Float         @default(0)
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  incomes     Income[]
  expenses    Expense[]
}

model User {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  password   String
  role       Role     @default(VIEWER)
  assemblyId String?
  assembly   Assembly? @relation(fields: [assemblyId], references: [id])
  status     String   @default("active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Assembly {
  id        String         @id @default(cuid())
  name      String
  location  String
  leader    String
  status    AssemblyStatus @default(ACTIVE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  users               User[]
  incomes             Income[]
  expenses            Expense[]
  assets              Asset[]
  receivables         Receivable[]
  ventureAllocations  VentureAllocation[]
  venturePayments     VenturePayment[]
}

model IncomeItem {
  id        String   @id @default(cuid())
  name      String   @unique
  isDefault Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Receivable {
  id            String        @id @default(cuid())
  assemblyId    String
  assembly      Assembly      @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  incomeId      String?
  income        Income?       @relation(fields: [incomeId], references: [id])
  date          DateTime
  currency      Currency
  amount        Float
  paymentMethod PaymentMethod
  sentToPastor  Boolean       @default(false)
  description   String        @default("")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ExpenseCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  isDefault Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Income {
  id             String       @id @default(cuid())
  assemblyId     String
  assembly       Assembly     @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id])
  date           DateTime
  currency       Currency
  adults         Int          @default(0)
  children       Int          @default(0)
  newSouls       Int          @default(0)
  offering       Float        @default(0)
  tithe          Float        @default(0)
  feastBadges    Float        @default(0)
  firewood       Float        @default(0)
  instruments    Float        @default(0)
  pastorsWelfare Float        @default(0)
  customItems    Json         @default("{}")
  totalAmount    Float        @default(0)
  sentToPastor   Float        @default(0)
  received       Float        @default(0)
  balance        Float        @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  receivables    Receivable[]
}

model OwedPerson {
  id        String    @id @default(cuid())
  name      String
  phone     String    @default("")
  role      String    @default("")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expenses  Expense[]
  refunds   Refund[]
}

model Expense {
  id            String        @id @default(cuid())
  assemblyId    String
  assembly      Assembly      @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id])
  date          DateTime
  currency      Currency
  event         String
  description   String
  category      String        @default("")
  amount        Float
  paidTo        String
  paymentSource PaymentSource
  owedPersonId  String?
  owedPerson    OwedPerson?   @relation(fields: [owedPersonId], references: [id])
  status        ExpenseStatus @default(PAID)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  refunds       Refund[]
}

model Refund {
  id           String     @id @default(cuid())
  expenseId    String
  expense      Expense    @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  owedPersonId String
  owedPerson   OwedPerson @relation(fields: [owedPersonId], references: [id])
  amount       Float
  currency     Currency
  date         DateTime
  note         String     @default("")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  userName    String
  userEmail   String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entity      String   // e.g. Income, Expense, Assembly, User, etc.
  entityId    String?
  description String
  metadata    Json     @default("{}")
  ipAddress   String   @default("")
  createdAt   DateTime @default(now())
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Asset {
  id            String         @id @default(cuid())
  name          String
  category      AssetCategory
  assemblyId    String
  assembly      Assembly       @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  purchaseDate  DateTime
  purchasePrice Float
  currency      Currency
  currentValue  Float
  condition     AssetCondition
  location      String
  assignedTo    String?
  serialNumber  String?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

// ─── Double-Entry Accounting ────────────────────────────────────

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model Account {
  id          String      @id @default(cuid())
  code        String      @unique // e.g. "1000", "2000", "4000"
  name        String      // e.g. "Cash at Hand", "Accounts Receivable"
  type        AccountType
  parentId    String?
  parent      Account?    @relation("AccountTree", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountTree")
  description String      @default("")
  isSystem    Boolean     @default(false) // system accounts can't be deleted
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  debitEntries  JournalEntry[] @relation("DebitAccount")
  creditEntries JournalEntry[] @relation("CreditAccount")
}

model JournalEntry {
  id             String   @id @default(cuid())
  date           DateTime
  debitAccountId String
  debitAccount   Account  @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccountId String
  creditAccount  Account  @relation("CreditAccount", fields: [creditAccountId], references: [id])
  amount         Float
  currency       Currency
  description    String
  reference      String   @default("") // e.g. "INC-xxx", "EXP-xxx", "REC-xxx"
  sourceType     String   @default("") // "Income", "Expense", "Receivable", "Refund"
  sourceId       String   @default("") // ID of the source record
  assemblyId     String?
  createdAt      DateTime @default(now())
}
